os: linux
dist: trusty
language: c
# Need all history to build change log.
git:
  depth: false
  quiet: true
matrix:
  include:
    - stage: "Smoke test"
      addons: &smoketest_addons
        apt:
          sources: &sources
            - ubuntu-toolchain-r-test
          packages:
            - &other_packages
              - &base_packages
                - autoconf
                - autogen
                - automake
                - autopoint
                - bzip2
                - bison
                - flex
                - gettext
                - libtool
                - perl
                - time
                - zpaq
              - &cups_packages
                - cups-filters
                - cups-filters-core-drivers
                - cups-client
                - libcups2-dev
                - libcupsimage2-dev
                - libusb-1.0-0-dev
              - valgrind
            - &gimp_packages
              - libgimp2.0-dev
            - &doc_packages
              - docbook
              - docbook-dsssl
              - docbook-simple
              - docbook-utils
              - docbook-xml
              - docbook-xsl
              - doxygen
              - dvips-fontdata-n2bk
              - imagemagick
              - jade
              - jadetex
              - openjade
              - sgml-base
              - sgml-data
              - sgmltools-lite
              - texi2html
            - gcc-8
      script: scripts/travis/smoke


    - stage: "Integration tests"
      name: "Base build"
      script: scripts/travis/smoke
      addons: *smoketest_addons

    -
      script: scripts/travis/integration gcc-4.9 0
      env: &integration_env
        - STP_TEST_ROTOR_CIRCUMFERENCE=4
      name: gcc-4.9
      addons: &gcc-4_9-addons
        apt:
          sources:
           - *sources
          packages:
            - *other_packages
            - gcc-4.9
    -
      script: scripts/travis/integration gcc-7 1
      env: *integration_env
      name: gcc-7
      addons: &gcc-7-addons
        apt:
          sources:
            - *sources
          packages:
            - *other_packages
            - gcc-7
    -
      script: scripts/travis/integration clang-5.0 2
      env: *integration_env
      name: gcc-8
      addons: &clang-5_0-addons
        apt:
          sources:
            - *sources
            - llvm-toolchain-trusty-5.0
          packages:
            - *other_packages
            - clang-5.0
    -
      script: scripts/travis/integration clang-3.9 3
      env: *integration_env
      name: clang-3.9
      addons: &clang-3_8-addons
        apt:
          sources:
            - *sources
            - llvm-toolchain-trusty-3.9
          packages:
            - *other_packages
            - clang-3.9


    - stage: "Checksums"
      env: &checksum_env
        - STP_TEST_ROTOR_CIRCUMFERENCE=10
      script: scripts/travis/checksums 0
      addons: &checksum_addons
        apt:
          sources:
            - *sources
          packages:
            - *base_packages
    -
      script: scripts/travis/checksums 1
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 2
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 3
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 4
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 5
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 6
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 7
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 8
      env: *checksum_env
      addons: *checksum_addons
    -
      script: scripts/travis/checksums 9
      env: *checksum_env
      addons: *checksum_addons


    - stage: "Full tests"
      name: 0 gcc-4.9
      env: &full_env
        - STP_TEST_ROTOR_CIRCUMFERENCE=15
      script: scripts/travis/full gcc-4.9 0
      addons: *gcc-4_9-addons
    -
      name: 1 gcc-7
      env: *full_env
      script: scripts/travis/full gcc-7 1
      addons: *gcc-7-addons
    -
      name: 2 gcc-8
      env: *full_env
      script: scripts/travis/full gcc-8 2
      addons: &gcc-8-addons
        apt:
          sources:
            - *sources
          packages:
            - *other_packages
            - gcc-8
    -
      name: 3 clang-3.9
      env: *full_env
      script: scripts/travis/full clang-3.9 3
      addons: *clang-3_8-addons
    -
      name: 4 clang-5.0
      env: *full_env
      script: scripts/travis/full clang-5.0 4
      addons: *clang-5_0-addons
    -
      name: 5 gcc-4.9
      env: *full_env
      script: scripts/travis/full gcc-4.9 5
      addons: *gcc-4_9-addons
    -
      name: 6 gcc-7
      env: *full_env
      script: scripts/travis/full gcc-7 6
      addons: *gcc-7-addons
    -
      name: 7 gcc-8
      env: *full_env
      script: scripts/travis/full gcc-8 7
      addons: *gcc-8-addons
    -
      name: 8 clang-3.9
      env: *full_env
      script: scripts/travis/full clang-3.9 8
      addons: *clang-3_8-addons
    -
      name: 9 clang-5.0
      env: *full_env
      script: scripts/travis/full clang-5.0 9
      addons: *clang-5_0-addons
    -
      name: 10 gcc-4.9
      env: *full_env
      script: scripts/travis/full gcc-4.9 10
      addons: *gcc-4_9-addons
    -
      name: 11 gcc-7
      env: *full_env
      script: scripts/travis/full gcc-7 11
      addons: *gcc-7-addons
    -
      name: 12 gcc-8
      env: *full_env
      script: scripts/travis/full gcc-8 12
      addons: *gcc-8-addons
    -
      name: 13 clang-3.9
      env: *full_env
      script: scripts/travis/full clang-3.9 13
      addons: *clang-3_8-addons
    -
      name: 14 clang-5.0
      env: *full_env
      script: scripts/travis/full clang-5.0 14
      addons: *clang-5_0-addons

stages:
  - name: "Smoke test"
    if: type = cron
  - name: "Integration tests"
    if: type IN (push, pull_request)
  - name: "Checksums"
    # Turn this off until we can do something with the output.
    if: 1 = 0 AND branch = "master" AND type != cron
  - name: "Full tests"
    if: type = cron

notifications:
  email:
    recipients:
      - rlk@alum.mit.edu
    on_success: always
    on_failure: always
